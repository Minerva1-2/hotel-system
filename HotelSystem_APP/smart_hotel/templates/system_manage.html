<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>é…’åº—æˆ¿å¡ç®¡ç†åå°</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; padding: 20px; color: #333; }
        /* å®¹å™¨æ”¹ä¸º flex å¸ƒå±€ä»¥ä¾¿å¤„ç†é«˜åº¦ï¼Œæˆ–è€…ç»´æŒ grid */
        .container { max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .full-width { grid-column: 1 / -1; }

        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); display: flex; flex-direction: column; }
        h2 { margin-top: 0; color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; display: inline-block; margin-bottom: 20px;}

        input { padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 10px; box-sizing: border-box; width: 100%; }
        button { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; color: white; transition: 0.3s; font-weight: bold; }
        button:hover { opacity: 0.9; }

        .btn-blue { background: #3498db; }
        .btn-green { background: #2ecc71; }
        .btn-red { background: #e74c3c; }

        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }

        .user-mgmt-box { padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .user-add { background: #f0f9ff; border: 1px solid #bae6fd; }
        .user-del { background: #fef2f2; border: 1px solid #fecaca; }
        .box-title { margin-top: 0; font-size: 16px; margin-bottom: 10px; }

        /* ========================================= */
        /* [æ ¸å¿ƒä¿®æ”¹] æˆ¿é—´ç½‘æ ¼åˆ—è¡¨æ ·å¼ */
        /* ========================================= */

        /* åˆ—è¡¨å®¹å™¨ï¼šè‡ªåŠ¨å¡«å……ï¼Œæ¯åˆ—æœ€å°å®½åº¦ 130px */
        .room-grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 15px;
            max-height: 400px; /* å›ºå®šé«˜åº¦ */
            overflow-y: auto;  /* è¶…å‡ºé«˜åº¦æ˜¾ç¤ºæ»šåŠ¨æ¡ */
            padding: 5px;      /* é¿å…é˜´å½±è¢«åˆ‡æ‰ */
        }

        /* å•ä¸ªæˆ¿é—´å°å¡ç‰‡ */
        .room-card {
            background: #fff;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 15px 10px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
            overflow: hidden;
        }

        /* é¼ æ ‡æ‚¬åœæ•ˆæœ */
        .room-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        /* çŠ¶æ€é¡¶æ é¢œè‰²æ¡ */
        .room-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 4px;
        }

        /* ç©ºé—²çŠ¶æ€æ ·å¼ */
        .card-status-0 { background: #f9fff9; } /* ææ·¡ç»¿èƒŒæ™¯ */
        .card-status-0::before { background: #2ecc71; } /* ç»¿è‰²é¡¶æ¡ */
        .card-status-0 .r-status-text { color: #27ae60; background: #e8f8f5; }

        /* å…¥ä½çŠ¶æ€æ ·å¼ */
        .card-status-1 { background: #fff5f5; } /* ææ·¡çº¢èƒŒæ™¯ */
        .card-status-1::before { background: #e74c3c; } /* çº¢è‰²é¡¶æ¡ */
        .card-status-1 .r-status-text { color: #c0392b; background: #fadbd8; }

        /* æˆ¿é—´å·å¤§å­— */
        .r-number {
            font-size: 24px;
            font-weight: bold;
            color: #34495e;
            margin-bottom: 8px;
            display: block;
        }

        /* çŠ¶æ€æ ‡ç­¾ */
        .r-status-text {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        /* å®¢äººå§“å/è¯¦æƒ… */
        .r-info {
            font-size: 13px;
            color: #7f8c8d;
            margin-top: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis; /* åå­—å¤ªé•¿æ˜¾ç¤ºçœç•¥å· */
        }

        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
        .room-grid-container::-webkit-scrollbar { width: 6px; }
        .room-grid-container::-webkit-scrollbar-thumb { background-color: #ccc; border-radius: 3px; }
        .room-grid-container::-webkit-scrollbar-track { background-color: #f1f1f1; }

    </style>
</head>
<body>
    <h1 style="text-align:center; color:#2c3e50;">ğŸ¨ é…’åº—ç‰©è”ç½‘ç®¡ç†åå°</h1>

    <div class="container">

        <div class="card">
            <h2>ğŸ“¡ è¿œç¨‹ç”¨æˆ·ç®¡ç† (ä¸Šä½æœº)</h2>
            <div class="user-mgmt-box user-add">
                <h3 class="box-title" style="color:#0284c7;">â• æ·»åŠ æ–°ç”¨æˆ·</h3>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="qtUserAdd" placeholder="ç”¨æˆ·å" style="flex:1;">
                    <input type="password" id="qtPassAdd" placeholder="å¯†ç " style="flex:1;">
                </div>
                <button class="btn-blue" style="width:100%" onclick="syncUser('add')">å‘é€æ·»åŠ æŒ‡ä»¤</button>
            </div>

            <div class="user-mgmt-box user-del">
                <h3 class="box-title" style="color:#dc2626;">âŒ åˆ é™¤ç”¨æˆ·</h3>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="qtUserDel" placeholder="è¦åˆ é™¤çš„ç”¨æˆ·å" style="flex:1;">
                    <button class="btn-red" style="width: 100px;" onclick="syncUser('del')">åˆ é™¤</button>
                </div>
            </div>
        </div>

        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2 style="border:none; margin-bottom:0;">ğŸ›ï¸ æˆ¿é—´å®æ—¶ç›‘æ§</h2>
                <span style="font-size:12px; color:#888;">ğŸŸ¢ åœ¨çº¿ç›‘æ§ä¸­</span>
            </div>
            <hr style="border:0; border-top:2px solid #3498db; margin: 10px 0 20px 0; width: 100%;">

            <div class="room-grid-container" id="roomContainer">
                {% for room in rooms %}
                <div class="room-card card-status-{{ room.status }}">
                    <span class="r-number">{{ room.room_id }}</span>

                    {% if room.status == 1 %}
                        <div class="r-status-text">å·²å…¥ä½</div>
                        <div class="r-info">ğŸ‘¤ {{ room.guest_name }}</div>
                    {% else %}
                        <div class="r-status-text">ç©ºé—²</div>
                        <div class="r-info" style="color:#2ecc71;">Wait...</div>
                    {% endif %}

                    <div class="r-info" style="font-size:11px; margin-top:5px; opacity:0.6;">
                        {{ room.last_update|date:"H:i:s" }}
                    </div>
                </div>
                {% empty %}
                <div style="grid-column: 1/-1; text-align:center; padding: 40px; color: #999;">
                    æš‚æ— æˆ¿é—´æ•°æ®ä¸ŠæŠ¥
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="card full-width">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2>ğŸ’¾ ç³»ç»Ÿç¾å¤‡æ§åˆ¶å°</h2>
                <button class="btn-green" onclick="createBackup()">â• æ–°å»ºå¤‡ä»½</button>
            </div>

            <table>
                <thead><tr><th>ID</th><th>æ–‡ä»¶å</th><th>æ—¶é—´</th><th>å¤§å°</th><th>æ“ä½œ</th></tr></thead>
                <tbody>
                    {% for bk in backups %}
                    <tr>
                        <td>{{ bk.id }}</td>
                        <td>{{ bk.filename }}</td>
                        <td>{{ bk.created_at|date:"Y-m-d H:i" }}</td>
                        <td>{{ bk.size_kb }} KB</td>
                        <td>
                            <button class="btn-red" onclick="restoreBackup({{ bk.id }})">â†º æ¢å¤å¹¶é‡ç½®</button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="5" style="text-align:center; color:#999">æš‚æ— å¤‡ä»½è®°å½•</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // é€šç”¨ Fetch å°è£…
        async function postData(url, data) {
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                return await response.json();
            } catch (error) {
                return { status: 'error', msg: 'ç½‘ç»œè¯·æ±‚å¤±è´¥: ' + error };
            }
        }

        // ç”¨æˆ·ç®¡ç†é€»è¾‘ (Add/Del)
        function syncUser(action) {
            if (action === 'add') {
                const u = document.getElementById('qtUserAdd').value;
                const p = document.getElementById('qtPassAdd').value;
                if(!u || !p) return alert("è¯·å¡«å†™å®Œæ•´çš„ç”¨æˆ·åå’Œå¯†ç ï¼");

                postData('/smart_hotel/api/sync_user/', {username: u, password: p})
                    .then(res => {
                        alert(res.msg);
                        if(res.status === 'success') {
                            document.getElementById('qtUserAdd').value = '';
                            document.getElementById('qtPassAdd').value = '';
                        }
                    });
            }
            else if (action === 'del') {
                const u = document.getElementById('qtUserDel').value;
                if(!u) return alert("è¯·è¾“å…¥è¦åˆ é™¤çš„ç”¨æˆ·åï¼");

                if(!confirm("âš ï¸ è­¦å‘Šï¼š\nç¡®å®šè¦å¼ºåˆ¶åˆ é™¤ä¸Šä½æœºç”¨æˆ· [" + u + "] å—ï¼Ÿ\næ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚")) return;

                postData('/smart_hotel/api/delete_user/', {username: u})
                    .then(res => {
                        alert(res.msg);
                        if(res.status === 'success') {
                            document.getElementById('qtUserDel').value = '';
                        }
                    });
            }
        }

        function createBackup() {
            if(confirm("ç¡®å®šå¤‡ä»½å½“å‰æ‰€æœ‰ä¸šåŠ¡æ•°æ®å—ï¼Ÿ")) {
                fetch('/smart_hotel/api/backup/')
                    .then(r => r.json()).then(res => {
                        alert(res.msg);
                        if(res.status === 'success') location.reload();
                    });
            }
        }

        function restoreBackup(id) {
            if(confirm("âš ï¸ é«˜å±æ“ä½œè­¦å‘Šï¼š\nç¡®å®šè¦å›æ»šåˆ°æ­¤ç‰ˆæœ¬å—ï¼Ÿ")) {
                postData('/smart_hotel/api/restore/', {id: id})
                    .then(res => {
                        alert(res.msg);
                        if(res.status === 'success') location.reload();
                    });
            }
        }
    </script>
</body>
</html>